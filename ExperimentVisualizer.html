<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditory Experiment Analysis & Visualization</title>

    <!-- External Dependencies via CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .upload-section:hover {
            border-color: #764ba2;
            background: #f0f1f5;
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .upload-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .chart-container {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        canvas {
            max-height: 400px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .info-message {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .error-message {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #c62828;
        }

        .tab-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tab:hover {
            color: #667eea;
            background: #f8f9fa;
        }

        .confusion-matrix {
            display: inline-block;
            margin: 20px 0;
        }

        .confusion-cell {
            display: inline-block;
            width: 40px;
            height: 40px;
            text-align: center;
            line-height: 40px;
            margin: 1px;
            font-size: 0.8em;
            color: white;
            font-weight: bold;
        }

        .footer {
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Statistical Analysis Functions (Recreating MATLAB computations)
        const StatisticalAnalysis = {
            // Compute d-prime from confusion matrix
            computeDPrime: (confusionMatrix) => {
                if (!confusionMatrix || confusionMatrix.length === 0) return 0;

                const n = confusionMatrix.length;
                let hits = 0, falseAlarms = 0, totalSignal = 0, totalNoise = 0;

                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        const count = confusionMatrix[i][j] || 0;
                        if (i === j) {
                            hits += count;
                            totalSignal += count;
                        } else {
                            falseAlarms += count;
                            totalNoise += count + count; // Each off-diagonal contributes to both
                        }
                    }
                }

                const hitRate = Math.max(0.01, Math.min(0.99, totalSignal > 0 ? hits / totalSignal : 0));
                const faRate = Math.max(0.01, Math.min(0.99, totalNoise > 0 ? falseAlarms / totalNoise : 0));

                // Convert to z-scores
                const zHit = StatisticalAnalysis.norminv(hitRate);
                const zFA = StatisticalAnalysis.norminv(faRate);

                return zHit - zFA;
            },

            // Approximate inverse normal CDF
            norminv: (p) => {
                // Beasley-Springer-Moro algorithm
                const a = [2.50662823884, -18.61500062529, 41.39119773534, -25.44106049637];
                const b = [-8.47351093090, 23.08336743743, -21.06224101826, 3.13082909833];
                const c = [0.3374754822726147, 0.9761690190917186, 0.1607979714918209,
                          0.0276438810333863, 0.0038405729373609, 0.0003951896511919,
                          0.0000321767881768, 0.0000002888167364, 0.0000003960315187];

                if (p <= 0 || p >= 1) return p <= 0 ? -6 : 6;

                const y = p - 0.5;
                if (Math.abs(y) < 0.42) {
                    const r = y * y;
                    let x = y * (((a[3] * r + a[2]) * r + a[1]) * r + a[0]);
                    x /= ((((b[3] * r + b[2]) * r + b[1]) * r + b[0]) * r + 1);
                    return x;
                }

                const r = p < 0.5 ? p : 1 - p;
                const s = Math.log(-Math.log(r));
                let t = c[0];
                for (let i = 1; i < c.length; i++) {
                    t += c[i] * Math.pow(s, i);
                }
                return p < 0.5 ? -t : t;
            },

            // Compute response bias
            computeBias: (confusionMatrix) => {
                if (!confusionMatrix || confusionMatrix.length === 0) return 1;

                const n = confusionMatrix.length;
                let hits = 0, falseAlarms = 0, totalSignal = 0, totalNoise = 0;

                for (let i = 0; i < n; i++) {
                    for (let j = 0; j < n; j++) {
                        const count = confusionMatrix[i][j] || 0;
                        if (i === j) {
                            hits += count;
                            totalSignal += count;
                        } else {
                            falseAlarms += count;
                            totalNoise += count + count;
                        }
                    }
                }

                const hitRate = Math.max(0.01, Math.min(0.99, totalSignal > 0 ? hits / totalSignal : 0));
                const faRate = Math.max(0.01, Math.min(0.99, totalNoise > 0 ? falseAlarms / totalNoise : 0));

                const zHit = StatisticalAnalysis.norminv(hitRate);
                const zFA = StatisticalAnalysis.norminv(faRate);

                return Math.exp(-0.5 * (zHit * zHit - zFA * zFA));
            },

            // Chi-square test for response uniformity
            chiSquareTest: (responses, numCategories) => {
                const observed = new Array(numCategories).fill(0);
                responses.forEach(r => {
                    if (r >= 0 && r < numCategories) observed[r]++;
                });

                const total = responses.length;
                const expected = total / numCategories;

                let chiSq = 0;
                for (let i = 0; i < numCategories; i++) {
                    chiSq += Math.pow(observed[i] - expected, 2) / expected;
                }

                const df = numCategories - 1;
                const pValue = 1 - StatisticalAnalysis.chiSquareCDF(chiSq, df);

                return { chiSquare: chiSq, df, pValue };
            },

            // Chi-square CDF approximation
            chiSquareCDF: (x, k) => {
                if (x <= 0) return 0;
                return StatisticalAnalysis.gammaIncomplete(k/2, x/2);
            },

            // Incomplete gamma function (for chi-square)
            gammaIncomplete: (a, x) => {
                if (x <= 0) return 0;
                if (x > 100) return 1;

                let sum = 0, term = 1/a, n = 0;
                while (Math.abs(term) > 1e-10 && n < 100) {
                    sum += term;
                    n++;
                    term *= x / (a + n);
                }

                return sum * Math.exp(-x + a * Math.log(x) - StatisticalAnalysis.logGamma(a));
            },

            // Log gamma function
            logGamma: (x) => {
                const cof = [76.18009172947146, -86.50532032941677, 24.01409824083091,
                            -1.231739572450155, 0.001208650973866179, -0.000005395239384953];
                let y = x, tmp = x + 5.5;
                tmp -= (x + 0.5) * Math.log(tmp);
                let ser = 1.000000000190015;
                for (let j = 0; j < 6; j++) ser += cof[j] / ++y;
                return -tmp + Math.log(2.5066282746310005 * ser / x);
            },

            // One-way ANOVA
            oneWayANOVA: (groups) => {
                const allData = groups.flat();
                const grandMean = allData.reduce((a, b) => a + b, 0) / allData.length;

                // Between-group sum of squares
                let ssb = 0;
                groups.forEach(group => {
                    const groupMean = group.reduce((a, b) => a + b, 0) / group.length;
                    ssb += group.length * Math.pow(groupMean - grandMean, 2);
                });

                // Within-group sum of squares
                let ssw = 0;
                groups.forEach(group => {
                    const groupMean = group.reduce((a, b) => a + b, 0) / group.length;
                    group.forEach(val => {
                        ssw += Math.pow(val - groupMean, 2);
                    });
                });

                const k = groups.length;
                const n = allData.length;
                const dfb = k - 1;
                const dfw = n - k;

                const msb = ssb / dfb;
                const msw = ssw / dfw;
                const fStat = msb / msw;

                // Approximate p-value using F-distribution
                const pValue = 1 - StatisticalAnalysis.fCDF(fStat, dfb, dfw);

                return { fStatistic: fStat, dfBetween: dfb, dfWithin: dfw, pValue };
            },

            // F-distribution CDF approximation
            fCDF: (x, d1, d2) => {
                if (x <= 0) return 0;
                const beta = StatisticalAnalysis.betaIncomplete(d1/2, d2/2, (d1*x)/(d1*x + d2));
                return beta;
            },

            // Incomplete beta function
            betaIncomplete: (a, b, x) => {
                if (x <= 0) return 0;
                if (x >= 1) return 1;

                const bt = Math.exp(a * Math.log(x) + b * Math.log(1 - x) -
                                   StatisticalAnalysis.logGamma(a) -
                                   StatisticalAnalysis.logGamma(b) +
                                   StatisticalAnalysis.logGamma(a + b));

                if (x < (a + 1) / (a + b + 2)) {
                    return bt * StatisticalAnalysis.betaCF(a, b, x) / a;
                } else {
                    return 1 - bt * StatisticalAnalysis.betaCF(b, a, 1 - x) / b;
                }
            },

            // Beta continued fraction
            betaCF: (a, b, x) => {
                const maxIter = 100;
                const eps = 1e-10;

                let qab = a + b;
                let qap = a + 1;
                let qam = a - 1;
                let c = 1;
                let d = 1 - qab * x / qap;
                if (Math.abs(d) < eps) d = eps;
                d = 1 / d;
                let h = d;

                for (let m = 1; m <= maxIter; m++) {
                    const m2 = 2 * m;
                    const aa = m * (b - m) * x / ((qam + m2) * (a + m2));
                    d = 1 + aa * d;
                    if (Math.abs(d) < eps) d = eps;
                    c = 1 + aa / c;
                    if (Math.abs(c) < eps) c = eps;
                    d = 1 / d;
                    h *= d * c;

                    const aa2 = -(a + m) * (qab + m) * x / ((a + m2) * (qap + m2));
                    d = 1 + aa2 * d;
                    if (Math.abs(d) < eps) d = eps;
                    c = 1 + aa2 / c;
                    if (Math.abs(c) < eps) c = eps;
                    d = 1 / d;
                    const del = d * c;
                    h *= del;

                    if (Math.abs(del - 1) < eps) break;
                }

                return h;
            }
        };

        // Main App Component
        function ExperimentVisualizer() {
            const [data, setData] = useState(null);
            const [activeTab, setActiveTab] = useState('overview');
            const [error, setError] = useState(null);
            const chartRefs = useRef({});

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setError(null);

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        setData(jsonData);
                    } catch (err) {
                        setError('Error parsing JSON file: ' + err.message);
                    }
                };
                reader.onerror = () => {
                    setError('Error reading file');
                };
                reader.readAsText(file);
            };

            const renderChart = (chartId, type, data, options) => {
                useEffect(() => {
                    if (!data) return;

                    const ctx = document.getElementById(chartId);
                    if (!ctx) return;

                    // Destroy existing chart
                    if (chartRefs.current[chartId]) {
                        chartRefs.current[chartId].destroy();
                    }

                    // Create new chart
                    chartRefs.current[chartId] = new Chart(ctx, {
                        type: type,
                        data: data,
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            ...options
                        }
                    });

                    return () => {
                        if (chartRefs.current[chartId]) {
                            chartRefs.current[chartId].destroy();
                        }
                    };
                }, [chartId, data]);

                return <canvas id={chartId}></canvas>;
            };

            const renderOverview = () => {
                if (!data) return null;

                const stats = data.statistics || {};
                const expType = data.experiment || 'unknown';

                return (
                    <div>
                        <div className="stats-grid">
                            <div className="stat-card">
                                <div className="stat-label">Overall Accuracy</div>
                                <div className="stat-value">{(stats.overall_accuracy || 0).toFixed(1)}%</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">Mean RT</div>
                                <div className="stat-value">{(stats.mean_rt || 0).toFixed(3)}s</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">d-prime</div>
                                <div className="stat-value">{(stats.d_prime || 0).toFixed(2)}</div>
                            </div>
                            <div className="stat-card">
                                <div className="stat-label">Response Bias</div>
                                <div className="stat-value">{(stats.response_bias || 1).toFixed(2)}</div>
                            </div>
                        </div>

                        <div className="info-message">
                            <strong>Experiment:</strong> {data.experiment || 'N/A'} |
                            <strong> Subject:</strong> {data.subject_id || 'N/A'} |
                            <strong> Condition:</strong> {data.condition || 'N/A'} |
                            <strong> Trials:</strong> {data.num_trials || 'N/A'} |
                            <strong> Date:</strong> {data.timestamp || 'N/A'}
                        </div>

                        {stats.accuracy_by_stimulus && (
                            <div className="chart-container">
                                <div className="chart-title">Accuracy by Stimulus</div>
                                {renderChart('accuracyByStimulus', 'bar', {
                                    labels: Object.keys(stats.accuracy_by_stimulus),
                                    datasets: [{
                                        label: 'Accuracy (%)',
                                        data: Object.values(stats.accuracy_by_stimulus),
                                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        borderWidth: 2
                                    }]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: { callback: (val) => val + '%' }
                                        }
                                    }
                                })}
                            </div>
                        )}

                        {stats.accuracy_by_speaker && (
                            <div className="chart-container">
                                <div className="chart-title">Accuracy by Speaker</div>
                                {renderChart('accuracyBySpeaker', 'bar', {
                                    labels: Object.keys(stats.accuracy_by_speaker),
                                    datasets: [{
                                        label: 'Accuracy (%)',
                                        data: Object.values(stats.accuracy_by_speaker),
                                        backgroundColor: 'rgba(118, 75, 162, 0.8)',
                                        borderColor: 'rgba(118, 75, 162, 1)',
                                        borderWidth: 2
                                    }]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: { callback: (val) => val + '%' }
                                        }
                                    }
                                })}
                            </div>
                        )}
                    </div>
                );
            };

            const renderConfusionMatrix = () => {
                if (!data || !data.statistics || !data.statistics.confusion_matrix) return null;

                const matrix = data.statistics.confusion_matrix;
                const labels = data.stimulus_labels || [];

                // Find max value for color scaling
                const maxVal = Math.max(...matrix.flat());

                const getColor = (val) => {
                    const intensity = val / maxVal;
                    const r = Math.floor(255 * (1 - intensity));
                    const g = Math.floor(255 * (1 - intensity * 0.5));
                    const b = 255;
                    return `rgb(${r}, ${g}, ${b})`;
                };

                return (
                    <div className="chart-container">
                        <div className="chart-title">Confusion Matrix</div>
                        <div style={{ overflowX: 'auto' }}>
                            <table style={{ margin: '20px auto', borderCollapse: 'collapse' }}>
                                <thead>
                                    <tr>
                                        <th style={{ padding: '10px', border: '1px solid #ddd' }}>Target \ Response</th>
                                        {labels.map(label => (
                                            <th key={label} style={{ padding: '10px', border: '1px solid #ddd', fontSize: '0.9em' }}>
                                                {label}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {matrix.map((row, i) => (
                                        <tr key={i}>
                                            <th style={{ padding: '10px', border: '1px solid #ddd', fontSize: '0.9em' }}>
                                                {labels[i]}
                                            </th>
                                            {row.map((val, j) => (
                                                <td key={j} style={{
                                                    padding: '10px',
                                                    border: '1px solid #ddd',
                                                    backgroundColor: getColor(val),
                                                    color: val > maxVal * 0.5 ? 'white' : 'black',
                                                    fontWeight: i === j ? 'bold' : 'normal',
                                                    textAlign: 'center'
                                                }}>
                                                    {val}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderCRMAnalysis = () => {
                if (!data || data.experiment !== 'CRM') return null;

                const stats = data.statistics || {};

                return (
                    <div>
                        <div className="stats-grid">
                            {stats.threshold_db !== undefined && (
                                <div className="stat-card">
                                    <div className="stat-label">Threshold (dB SNR)</div>
                                    <div className="stat-value">{stats.threshold_db.toFixed(2)}</div>
                                </div>
                            )}
                            {stats.total_reversals !== undefined && (
                                <div className="stat-card">
                                    <div className="stat-label">Total Reversals</div>
                                    <div className="stat-value">{stats.total_reversals}</div>
                                </div>
                            )}
                            {stats.mean_snr !== undefined && (
                                <div className="stat-card">
                                    <div className="stat-label">Mean SNR</div>
                                    <div className="stat-value">{stats.mean_snr.toFixed(2)}</div>
                                </div>
                            )}
                        </div>

                        {stats.accuracy_by_color && (
                            <div className="chart-container">
                                <div className="chart-title">Accuracy by Color</div>
                                {renderChart('accuracyByColor', 'bar', {
                                    labels: ['Blue', 'Red', 'White', 'Green'],
                                    datasets: [{
                                        label: 'Accuracy (%)',
                                        data: Object.values(stats.accuracy_by_color),
                                        backgroundColor: ['rgba(33, 150, 243, 0.8)', 'rgba(244, 67, 54, 0.8)',
                                                         'rgba(158, 158, 158, 0.8)', 'rgba(76, 175, 80, 0.8)'],
                                        borderWidth: 2
                                    }]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: { callback: (val) => val + '%' }
                                        }
                                    }
                                })}
                            </div>
                        )}

                        {stats.accuracy_by_number && (
                            <div className="chart-container">
                                <div className="chart-title">Accuracy by Number</div>
                                {renderChart('accuracyByNumber', 'bar', {
                                    labels: Object.keys(stats.accuracy_by_number),
                                    datasets: [{
                                        label: 'Accuracy (%)',
                                        data: Object.values(stats.accuracy_by_number),
                                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                        borderWidth: 2
                                    }]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: { callback: (val) => val + '%' }
                                        }
                                    }
                                })}
                            </div>
                        )}

                        {stats.accuracy_by_run && (
                            <div className="chart-container">
                                <div className="chart-title">Accuracy by Run</div>
                                {renderChart('accuracyByRun', 'line', {
                                    labels: Object.keys(stats.accuracy_by_run),
                                    datasets: [{
                                        label: 'Accuracy (%)',
                                        data: Object.values(stats.accuracy_by_run),
                                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                                        borderColor: 'rgba(102, 126, 234, 1)',
                                        borderWidth: 3,
                                        fill: true
                                    }]
                                }, {
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: 100,
                                            ticks: { callback: (val) => val + '%' }
                                        }
                                    }
                                })}
                            </div>
                        )}
                    </div>
                );
            };

            const renderStatistics = () => {
                if (!data) return null;

                const statsTests = data.statistical_tests || {};
                const stats = data.statistics || {};

                return (
                    <div>
                        <div className="chart-container">
                            <div className="chart-title">Statistical Tests</div>
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Test</th>
                                            <th>Statistic</th>
                                            <th>p-value</th>
                                            <th>Interpretation</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {statsTests.chi2_stat !== undefined && (
                                            <tr>
                                                <td>Chi-Square (Response Uniformity)</td>
                                                <td>{statsTests.chi2_stat.toFixed(3)}</td>
                                                <td>{statsTests.chi2_pval.toFixed(4)}</td>
                                                <td>{statsTests.chi2_pval < 0.05 ? 'Significant' : 'Not Significant'}</td>
                                            </tr>
                                        )}
                                        {statsTests.anova_f !== undefined && (
                                            <tr>
                                                <td>One-Way ANOVA (Accuracy by Stimulus)</td>
                                                <td>F = {statsTests.anova_f.toFixed(3)}</td>
                                                <td>{statsTests.anova_p.toFixed(4)}</td>
                                                <td>{statsTests.anova_p < 0.05 ? 'Significant' : 'Not Significant'}</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="chart-container">
                            <div className="chart-title">Descriptive Statistics</div>
                            <div className="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Measure</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Overall Accuracy</td>
                                            <td>{(stats.overall_accuracy || 0).toFixed(2)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Mean RT</td>
                                            <td>{(stats.mean_rt || 0).toFixed(3)} s</td>
                                        </tr>
                                        <tr>
                                            <td>Median RT</td>
                                            <td>{(stats.median_rt || 0).toFixed(3)} s</td>
                                        </tr>
                                        <tr>
                                            <td>SD RT</td>
                                            <td>{(stats.sd_rt || 0).toFixed(3)} s</td>
                                        </tr>
                                        <tr>
                                            <td>d-prime (Sensitivity)</td>
                                            <td>{(stats.d_prime || 0).toFixed(3)}</td>
                                        </tr>
                                        <tr>
                                            <td>Response Bias (Beta)</td>
                                            <td>{(stats.response_bias || 1).toFixed(3)}</td>
                                        </tr>
                                        {stats.correct_rt_mean !== undefined && (
                                            <tr>
                                                <td>Correct RT Mean</td>
                                                <td>{stats.correct_rt_mean.toFixed(3)} s</td>
                                            </tr>
                                        )}
                                        {stats.incorrect_rt_mean !== undefined && (
                                            <tr>
                                                <td>Incorrect RT Mean</td>
                                                <td>{stats.incorrect_rt_mean.toFixed(3)} s</td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="container">
                    <div className="header">
                        <h1>Auditory Experiment Analysis</h1>
                        <p>Interactive visualization and statistical analysis tool</p>
                    </div>

                    <div className="content">
                        {!data ? (
                            <div className="upload-section">
                                <h2 style={{ marginBottom: '20px' }}>Upload Experiment Data</h2>
                                <p style={{ marginBottom: '20px', color: '#666' }}>
                                    Select a JSON summary file from your experiment output
                                </p>
                                <input
                                    type="file"
                                    id="fileInput"
                                    accept=".json"
                                    onChange={handleFileUpload}
                                />
                                <label htmlFor="fileInput">
                                    <button className="upload-button" onClick={() => document.getElementById('fileInput').click()}>
                                        Choose File
                                    </button>
                                </label>
                            </div>
                        ) : (
                            <div>
                                <div className="tabs">
                                    <button
                                        className={`tab ${activeTab === 'overview' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('overview')}
                                    >
                                        Overview
                                    </button>
                                    <button
                                        className={`tab ${activeTab === 'confusion' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('confusion')}
                                    >
                                        Confusion Matrix
                                    </button>
                                    <button
                                        className={`tab ${activeTab === 'statistics' ? 'active' : ''}`}
                                        onClick={() => setActiveTab('statistics')}
                                    >
                                        Statistics
                                    </button>
                                    {data.experiment === 'CRM' && (
                                        <button
                                            className={`tab ${activeTab === 'crm' ? 'active' : ''}`}
                                            onClick={() => setActiveTab('crm')}
                                        >
                                            CRM Analysis
                                        </button>
                                    )}
                                </div>

                                {error && <div className="error-message">{error}</div>}

                                {activeTab === 'overview' && renderOverview()}
                                {activeTab === 'confusion' && renderConfusionMatrix()}
                                {activeTab === 'statistics' && renderStatistics()}
                                {activeTab === 'crm' && renderCRMAnalysis()}

                                <div style={{ marginTop: '30px', textAlign: 'center' }}>
                                    <button
                                        className="upload-button"
                                        onClick={() => {
                                            setData(null);
                                            setActiveTab('overview');
                                            setError(null);
                                        }}
                                    >
                                        Load Different File
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    <div className="footer">
                        <p>Auditory Experiment Visualizer v3.0 | Recreates MATLAB ExperimentCommon.m analyses</p>
                        <p style={{ marginTop: '10px', fontSize: '0.85em' }}>
                            Supports: Vowels, Consonants, CRM experiments | Multi-format output: CSV, JSON, Parquet
                        </p>
                    </div>
                </div>
            );
        }

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ExperimentVisualizer />);
    </script>
</body>
</html>
